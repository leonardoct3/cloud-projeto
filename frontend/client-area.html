<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIC - √Årea do Cliente</title>
    <meta name="description" content="√Årea do cliente Cloud25F - Gerenciamento e convers√£o de imagens">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚òÅÔ∏è</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="client-area.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="nav-container">
                <div class="logo">
                    <h2>Demays's Infra</h2>
                </div>
                <ul class="nav-menu" id="nav-menu">
                    <li><a href="http://site-cloud25f.s3-website.us-east-2.amazonaws.com/" class="nav-link">Voltar ao Site</a></li>
                    <li><a href="#gallery" class="nav-link">Minhas Imagens</a></li>
                    <li><a href="#upload" class="nav-link">Upload</a></li>
                    <li><button id="logout-btn" class="btn btn-secondary">Sair</button></li>
                </ul>
                <div class="hamburger" id="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <main class="client-main">
        <!-- User Info Section -->
        <section class="user-info">
            <div class="container">
                <div class="user-welcome">
                    <h1>√Årea do Cliente</h1>
                    <div class="user-details">
                        <label for="user-id">ID do Usu√°rio:</label>
                        <input type="text" id="user-id" placeholder="Digite seu ID de usu√°rio" value="user123">
                        <button id="load-images-btn" class="btn btn-secondary">Carregar Minhas Imagens</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Upload Section -->
        <section id="upload" class="upload-section">
            <div class="container">
                <div class="upload-card">
                    <div class="upload-header">
                        <h2>Convers√£o de Imagens para Base64</h2>
                        <p>Selecione uma imagem para converter e armazenar</p>
                    </div>
                    
                    <div class="upload-area" id="upload-area">
                        <div class="upload-placeholder">
                            <div class="upload-icon">üìÅ</div>
                            <p>Clique para selecionar uma imagem ou arraste aqui</p>
                            <p class="upload-formats">Suporte: JPG, PNG, GIF, WebP (m√°x. 10MB)</p>
                        </div>
                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                    </div>

                    <div class="selected-file" id="selected-file" style="display: none;">
                        <div class="file-info">
                            <span class="file-name"></span>
                            <span class="file-size"></span>
                            <button class="remove-file" id="remove-file">√ó</button>
                        </div>
                        <div class="file-preview">
                            <img id="preview-image" alt="Preview">
                        </div>
                    </div>

                    <button id="upload-btn" class="btn btn-secondary full-width" disabled>
                        <span class="btn-text">Enviar para Processamento</span>
                        <span class="btn-loading" style="display: none;">
                            <span class="spinner"></span>
                            Processando...
                        </span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Images Gallery Section -->
        <section id="gallery" class="gallery-section">
            <div class="container">
                <div class="gallery-header">
                    <h2>Suas Imagens Processadas</h2>
                    <div class="gallery-controls">
                        <button id="refresh-gallery" class="btn btn-secondary">
                            <span class="refresh-icon">üîÑ</span>
                            Atualizar
                        </button>
                        <div class="view-toggle">
                            <button id="grid-view" class="view-btn active">‚öè</button>
                            <button id="list-view" class="view-btn">‚ò∞</button>
                        </div>
                    </div>
                </div>

                <div class="gallery-loading" id="gallery-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Carregando imagens...</p>
                </div>

                <div class="gallery-empty" id="gallery-empty" style="display: none;">
                    <div class="empty-icon">üì∑</div>
                    <h3>Nenhuma imagem encontrada</h3>
                    <p>Fa√ßa upload de uma imagem para come√ßar</p>
                </div>

                <div class="gallery-grid grid-view" id="gallery-grid">
                    <!-- Images will be loaded here dynamically -->
                </div>
            </div>
        </section>
    </main>

    <!-- Image Modal -->
    <div class="modal" id="image-modal" style="display: none;">
        <div class="modal-overlay" id="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Detalhes da Imagem</h3>
                <button class="modal-close" id="modal-close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="modal-image-container">
                    <img id="modal-image" alt="Imagem processada">
                </div>
                <div class="modal-info">
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Nome:</label>
                            <span id="modal-filename"></span>
                        </div>
                        <div class="info-item">
                            <label>Tipo:</label>
                            <span id="modal-type"></span>
                        </div>
                        <div class="info-item">
                            <label>Tamanho:</label>
                            <span id="modal-size"></span>
                        </div>
                        <div class="info-item">
                            <label>Processado em:</label>
                            <span id="modal-date"></span>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button id="copy-base64" class="btn btn-secondary">Copiar Base64</button>
                        <button id="download-image" class="btn btn-secondary">Download</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script>
        class Cloud25FClient {
            constructor() {
                this.apiBase = '/api';
                this.currentUserId = null;
                this.selectedFile = null;
                this.viewMode = 'grid';
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadUserFromStorage();
            }

            setupEventListeners() {
                const self = this;

                // File upload
                const uploadAreaEl = document.getElementById('upload-area');
                if (uploadAreaEl) {
                    uploadAreaEl.addEventListener('click', () => {
                        document.getElementById('file-input').click();
                    });

                    uploadAreaEl.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadAreaEl.classList.add('drag-over');
                    });

                    uploadAreaEl.addEventListener('dragleave', () => {
                        uploadAreaEl.classList.remove('drag-over');
                    });

                    uploadAreaEl.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadAreaEl.classList.remove('drag-over');
                        self.handleFileSelect(e.dataTransfer.files[0]);
                    });
                }

                const fileInput = document.getElementById('file-input');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        self.handleFileSelect(e.target.files[0]);
                    });
                }

                const uploadBtn = document.getElementById('upload-btn');
                if (uploadBtn) uploadBtn.addEventListener('click', () => self.uploadImage());

                const removeFileBtn = document.getElementById('remove-file');
                if (removeFileBtn) removeFileBtn.addEventListener('click', () => self.clearSelectedFile());

                const loadBtn = document.getElementById('load-images-btn');
                if (loadBtn) loadBtn.addEventListener('click', () => self.setUserId());

                const userInput = document.getElementById('user-id');
                if (userInput) userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') self.setUserId();
                });

                const refreshBtn = document.getElementById('refresh-gallery');
                if (refreshBtn) refreshBtn.addEventListener('click', () => self.loadImages());

                const gridViewBtn = document.getElementById('grid-view');
                if (gridViewBtn) gridViewBtn.addEventListener('click', () => self.setViewMode('grid'));

                const listViewBtn = document.getElementById('list-view');
                if (listViewBtn) listViewBtn.addEventListener('click', () => self.setViewMode('list'));

                // Modal close (use self to ensure correct instance)
                const modalClose = document.getElementById('modal-close');
                if (modalClose) modalClose.addEventListener('click', function () {
                    self.closeModal();
                });

                const modalOverlay = document.getElementById('modal-overlay');
                if (modalOverlay) modalOverlay.addEventListener('click', function () {
                    self.closeModal();
                });

                const copyBtn = document.getElementById('copy-base64');
                if (copyBtn) copyBtn.addEventListener('click', () => self.copyBase64());

                const downloadBtn = document.getElementById('download-image');
                if (downloadBtn) downloadBtn.addEventListener('click', () => self.downloadImage());

                const hamburger = document.getElementById('hamburger');
                if (hamburger) hamburger.addEventListener('click', () => {
                    document.getElementById('nav-menu').classList.toggle('active');
                });
            }

            loadUserFromStorage() {
                const params = new URLSearchParams(window.location.search);
                const userIdParam = params.get('id');
                if (userIdParam) {
                    document.getElementById('user-id').value = userIdParam;
                    this.setUserId();
                    return;
                }
                const savedUserId = localStorage.getItem('cloud25f-user-id');
                if (savedUserId) {
                    document.getElementById('user-id').value = savedUserId;
                    this.setUserId();
                }
            }

            setUserId() {
                const userId = document.getElementById('user-id').value.trim();
                if (!userId) {
                    this.showNotification('Por favor, insira um ID de usu√°rio', 'error');
                    return;
                }
                
                this.currentUserId = userId;
                localStorage.setItem('cloud25f-user-id', userId);
                this.showNotification(`Usu√°rio definido: ${userId}`, 'success');
                this.loadImages();
            }

            handleFileSelect(file) {
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    this.showNotification('Por favor, selecione apenas arquivos de imagem', 'error');
                    return;
                }

                // Validate file size (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    this.showNotification('Arquivo muito grande. M√°ximo 10MB', 'error');
                    return;
                }

                this.selectedFile = file;
                this.showSelectedFile(file);
            }

            showSelectedFile(file) {
                const selectedFileDiv = document.getElementById('selected-file');
                const fileName = selectedFileDiv.querySelector('.file-name');
                const fileSize = selectedFileDiv.querySelector('.file-size');
                const previewImage = document.getElementById('preview-image');

                fileName.textContent = file.name;
                fileSize.textContent = this.formatFileSize(file.size);

                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                };
                reader.readAsDataURL(file);

                selectedFileDiv.style.display = 'block';
                document.getElementById('upload-area').style.display = 'none';
                document.getElementById('upload-btn').disabled = false;
            }

            clearSelectedFile() {
                this.selectedFile = null;
                document.getElementById('selected-file').style.display = 'none';
                document.getElementById('upload-area').style.display = 'block';
                document.getElementById('upload-btn').disabled = true;
                document.getElementById('file-input').value = '';
            }

            async uploadImage() {
                if (!this.selectedFile || !this.currentUserId) {
                    this.showNotification('Selecione uma imagem e defina um usu√°rio', 'error');
                    return;
                }

                const uploadBtn = document.getElementById('upload-btn');
                this.setButtonLoading(uploadBtn, true);

                try {
                    // Get presigned URL
                    const presignResponse = await fetch(`${this.apiBase}/presign`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filename: this.selectedFile.name,
                            content_type: this.selectedFile.type,
                            userId: this.currentUserId
                        })
                    });

                    if (!presignResponse.ok) {
                        throw new Error('Erro ao obter URL de upload');
                    }

                    const { url } = await presignResponse.json();

                    // Upload to S3
                    const uploadResponse = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': this.selectedFile.type,
                            'x-amz-meta-userid': this.currentUserId
                        },
                        body: this.selectedFile
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Erro no upload da imagem');
                    }

                    this.showNotification('Imagem enviada com sucesso! Processando...', 'success');
                    this.clearSelectedFile();
                    
                    // Wait a bit then refresh gallery
                    setTimeout(() => {
                        this.loadImages();
                    }, 2000);

                } catch (error) {
                    console.error('Upload error:', error);
                    this.showNotification('Erro no upload: ' + error.message, 'error');
                } finally {
                    this.setButtonLoading(uploadBtn, false);
                }
            }

            async loadImages() {
                if (!this.currentUserId) {
                    this.showNotification('Defina um ID de usu√°rio primeiro', 'error');
                    return;
                }

                const galleryGrid = document.getElementById('gallery-grid');
                const galleryLoading = document.getElementById('gallery-loading');
                const galleryEmpty = document.getElementById('gallery-empty');

                galleryLoading.style.display = 'block';
                galleryEmpty.style.display = 'none';
                galleryGrid.innerHTML = '';

                try {
                    const response = await fetch(`${this.apiBase}/images?userId=${encodeURIComponent(this.currentUserId)}`);

                    if (!response.ok) {
                        throw new Error('Erro ao carregar imagens');
                    }

                    const data = await response.json();
                    // API pode retornar { userId, images: [...] } ou apenas [...]
                    let images = [];
                    if (Array.isArray(data)) {
                        images = data;
                    } else if (data && Array.isArray(data.images)) {
                        images = data.images;
                    } else {
                        images = [];
                    }

                    if (!images || images.length === 0) {
                        galleryEmpty.style.display = 'block';
                    } else {
                        this.renderImages(images);
                    }

                } catch (error) {
                    console.error('Load images error:', error);
                    this.showNotification('Erro ao carregar imagens: ' + error.message, 'error');
                } finally {
                    galleryLoading.style.display = 'none';
                }
            }

            renderImages(images) {
                const galleryGrid = document.getElementById('gallery-grid');
                galleryGrid.innerHTML = '';

                images.forEach(image => {
                    const imageCard = this.createImageCard(image);
                    galleryGrid.appendChild(imageCard);
                });
            }

            createImageCard(image) {
                // image tem a forma: { imageId, sk, contentType, sizeBytes, totalChunks }
                const card = document.createElement('div');
                card.className = `image-card ${this.viewMode}`;

                const filename = image.imageId || 'Imagem';
                const sizeText = image.sizeBytes ? this.formatFileSize(Number(image.sizeBytes)) : '‚Äî';
                const createdText = image.created_at ? this.formatDate(image.created_at) : '';

                card.innerHTML = `
                    <div class="image-thumbnail">
                        <div class="image-placeholder">
                            <span class="image-icon">üñºÔ∏è</span>
                        </div>
                    </div>
                    <div class="image-info">
                        <h4 class="image-title">${filename}</h4>
                        <p class="image-meta">${createdText}</p>
                        <p class="image-size">${sizeText}</p>
                    </div>
                    <div class="image-actions">
                        <button class="btn-icon view-btn" title="Visualizar">üëÅÔ∏è</button>
                    </div>
                `;

                // Add click handlers
                const viewBtn = card.querySelector('.view-btn');
                viewBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.viewImage(filename);
                });

                card.addEventListener('click', () => {
                    this.viewImage(filename);
                });

                return card;
            }

            async viewImage(imageId) {
                if (!this.currentUserId) {
                    this.showNotification('Defina um ID de usu√°rio primeiro', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBase}/images/${encodeURIComponent(imageId)}?userId=${encodeURIComponent(this.currentUserId)}`);

                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Imagem n√£o encontrada');
                        }
                        throw new Error('Erro ao carregar imagem');
                    }

                    const imageData = await response.json();
                    this.showImageModal(imageData);

                } catch (error) {
                    console.error('View image error:', error);
                    this.showNotification('Erro ao visualizar imagem: ' + error.message, 'error');
                }
            }

            showImageModal(imageData) {
                const modal = document.getElementById('image-modal');
                const modalImage = document.getElementById('modal-image');
                const modalTitle = document.getElementById('modal-title');
                const modalFilename = document.getElementById('modal-filename');
                const modalType = document.getElementById('modal-type');
                const modalSize = document.getElementById('modal-size');
                const modalDate = document.getElementById('modal-date');

                const filename = imageData.imageId || 'Imagem';
                const contentType = (imageData.meta && imageData.meta.contentType) ? 
                    imageData.meta.contentType : (imageData.contentType || 'image/png');
                const sizeBytes = (imageData.meta && imageData.meta.sizeBytes) ? 
                    Number(imageData.meta.sizeBytes) : (imageData.sizeBytes ? Number(imageData.sizeBytes) : null);
                const createdAt = imageData.meta && imageData.meta.created_at ? imageData.meta.created_at : null;

                modalTitle.textContent = filename;
                modalFilename.textContent = filename;
                modalType.textContent = contentType;
                modalSize.textContent = sizeBytes ? this.formatFileSize(sizeBytes) : 'N/A';
                modalDate.textContent = createdAt ? this.formatDate(createdAt) : 'N/A';

                if (imageData.base64) {
                    modalImage.src = `data:${contentType};base64,${imageData.base64}`;
                    modalImage.dataset.base64 = imageData.base64;
                    modalImage.dataset.filename = filename;
                } else {
                    modalImage.src = '';
                    modalImage.dataset.base64 = '';
                    modalImage.dataset.filename = filename;
                }

                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            async copyBase64() {
                const modalImage = document.getElementById('modal-image');
                const base64Data = modalImage && modalImage.dataset ? modalImage.dataset.base64 : null;

                if (!base64Data) {
                    this.showNotification('Dados Base64 n√£o dispon√≠veis', 'error');
                    return;
                }

                // Tentar API moderna primeiro
                if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                    try {
                        await navigator.clipboard.writeText(base64Data);
                        this.showNotification('Base64 copiado para a √°rea de transfer√™ncia!', 'success');
                        return;
                    } catch (err) {
                        console.warn('navigator.clipboard.writeText falhou:', err);
                        // fallback pra execCommand abaixo
                    }
                }

                // Fallback: textarea + document.execCommand('copy')
                try {
                    const ta = document.createElement('textarea');
                    ta.value = base64Data;
                    // evitar exibir na tela
                    ta.style.position = 'fixed';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    ta.setSelectionRange(0, ta.value.length);
                    const ok = document.execCommand('copy');
                    document.body.removeChild(ta);
                    if (ok) {
                        this.showNotification('Base64 copiado (fallback)!', 'success');
                    } else {
                        throw new Error('execCommand copy retornou falso');
                    }
                } catch (err) {
                    console.error('Copy base64 fallback error:', err);
                    this.showNotification('Falha ao copiar Base64 (sem permiss√£o)', 'error');
                }
            }

            downloadImage() {
                const modalImage = document.getElementById('modal-image');
                const base64Data = modalImage.dataset.base64;
                const filename = modalImage.dataset.filename || 'image.jpg';

                if (!base64Data) {
                    this.showNotification('Imagem n√£o dispon√≠vel para download', 'error');
                    return;
                }

                const link = document.createElement('a');
                link.href = modalImage.src;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            setViewMode(mode) {
                this.viewMode = mode;
                document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`${mode}-view`).classList.add('active');
                
                const galleryGrid = document.getElementById('gallery-grid');
                galleryGrid.className = `gallery-grid ${mode}-view`;
            }

            setButtonLoading(button, loading) {
                const btnText = button.querySelector('.btn-text');
                const btnLoading = button.querySelector('.btn-loading');
                
                if (loading) {
                    btnText.style.display = 'none';
                    btnLoading.style.display = 'flex';
                    button.disabled = true;
                } else {
                    btnText.style.display = 'block';
                    btnLoading.style.display = 'none';
                    button.disabled = false;
                }
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                
                notification.innerHTML = `
                    <div class="notification-content">
                        <span class="notification-icon">${this.getNotificationIcon(type)}</span>
                        <span class="notification-message">${message}</span>
                        <button class="notification-close">√ó</button>
                    </div>
                `;

                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.remove();
                });

                container.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }

            getNotificationIcon(type) {
                switch (type) {
                    case 'success': return '‚úì';
                    case 'error': return '‚úó';
                    case 'info': return '‚Ñπ';
                    default: return '‚Ñπ';
                }
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            formatDate(dateString) {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleString('pt-BR');
            }

            closeModal() {
                const modal = document.getElementById('image-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new Cloud25FClient();
        });
    </script>
</body>
</html>
